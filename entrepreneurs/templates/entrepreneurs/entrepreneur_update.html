{% extends "feed/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
<div class="content-section">
    <div class="row mt-5">
        {% if entrepreneur.image_profile %}
            <div class="col-12 col-md-4">
                <img class="rounded-circle account-img" src="{{ entrepreneur.image_profile.url }}">
            </div>
        {% endif %}
        <div class="col-12 col-md-8 d-flex flex-column justify-content-center">
            <h2 class="account-heading">{{ user.username }}</h2>
            <p class="text-primary">{{ user.email }}</p>
        </div>
    </div>
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <fieldset class="form-group">
            <legend class="border-bottom mb-4">Informaci√≥n del Perfil</legend>
            {{ u_form|crispy }}
            {{ e_form|crispy }}
            {% comment %} {{ i_form|crispy }} {% endcomment %}
        </fieldset>

        <form>
            <fieldset class="form-group">

                <legend class="border-bottom mb-4">Fotos del emprendimiento</legend>
                <div class="row my-3" id="entrepreneurUploadedPhotos">
                    {% for photo in entrepreneur.photos.all %}
                            <div class="col-12 col-md-3 text-center" id="column_entrepreneur_photo_{{photo.pk}}">
                                <img id="entrepreneur_photo_{{photo.pk}}" class="rounded w-100" src="{{photo.image.url}}" alt="Foto del emprendedor">
                                <a name="link_remove_photo" href="">Eliminar <i class="fa fa-close"></i></a>
                            </div>    
                    {%endfor%}
                </div>

                <div id="survey_options">
                    <div class="input-group mb-3" name="survey_item">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="baseInputFile" name="survey_option">
                            <label class="custom-file-label" for="baseInputFile">Elegir archivo</label>
                        </div>
                    </div>
                </div>
            </fieldset>
        </form>

        <div class="form-group">
            <button class="btn btn-outline-info" type="submit">Actualizar</button>
        </div>
    </form>


    <script>
        document.getElementById("baseInputFile").addEventListener("change", function(event){
            const fileName = event.target.files[0].name;

            // TODO: Make request and save file in DB
            var randLetter = String.fromCharCode(65 + Math.floor(Math.random() * 26));
            var uniqid = randLetter + Date.now();

            // add to entrepreneurUploadedPhotos the new photo returned
            var newColumn = document.createElement('div');
            newColumn.setAttribute('class','col-12 col-md-3 text-center');
            newColumn.setAttribute('id', `column_entrepreneur_photo_${uniqid}`);

            var newPhoto = document.createElement('img');
            newPhoto.setAttribute('class','rounded w-100');
            var url = URL.createObjectURL(event.target.files[0])
            newPhoto.setAttribute('src', url);
            newPhoto.setAttribute('alt','Foto del emprendedor');
            newPhoto.setAttribute('id', `entrepreneur_photo_${uniqid}`);

            var newAnchor = document.createElement('a');
            newAnchor.setAttribute('href','');
            newAnchor.innerHTML = "Eliminar <i class='fa fa-close'></i>";
            newAnchor.addEventListener("click", function(e){
                e.preventDefault();
                // TODO: Make request and delete file in DB
                this.parentElement.remove()
            });

            newColumn.appendChild(newPhoto)
            newColumn.appendChild(newAnchor)

            var photoGallery = document.getElementById("entrepreneurUploadedPhotos")
            photoGallery.appendChild(newColumn);

            // Then clear the input for upload a new photo
        });

        anchor_tags = document.getElementsByName("link_remove_photo")
        if(anchor_tags.length > 0) {
            anchor_tags.forEach(anchor_tag => {
                anchor_tag.addEventListener("click", function(e) {
                    e.preventDefault();
                    // TODO: Make request and delete file in DB
                    this.parentElement.remove()
                });
            })
        }
    </script>
</div>
{% endblock content %}